<!DOCTYPE html>
<html lang="en">
  <!-- Beautiful Jekyll | MIT license | Copyright Dean Attali 2016 -->
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">

  <title>Introduction</title>

  <link rel="shortcut icon" type="image/x-icon" href="/img/Centre-logo.jpg">

  <meta name="author" content="Anthony Davidson" />

  

  <link rel="alternate" type="application/rss+xml" title="Creating maps in R - GIS and statistical support for researchers" href="/Creating-maps-in-R/feed.xml" />

  

  

  


  
    
      
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css" />


    
  

  
    
      <link rel="stylesheet" href="/Creating-maps-in-R/css/bootstrap.min.css" />
    
      <link rel="stylesheet" href="/Creating-maps-in-R/css/bootstrap-social.css" />
    
      <link rel="stylesheet" href="/Creating-maps-in-R/css/main.css" />
    
  

  
    
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
    
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
    
  

  

  

  

    <!-- Facebook OpenGraph tags -->
  

  
  <meta property="og:title" content="Introduction" />
  

   
  <meta property="og:description" content="Introduction ======================================================== This tutorial is an &quot;Introduction to Spatial Data and ggplot2&quot; and assumes no prior knowledge of spatial data analysis in R. We do recommend users are acquainted with the R command line before beginning the practicals though, perhaps via an 'Introduction to R' type tutorial, such as &quot;A...">
  


  <meta property="og:type" content="website" />

  
  <meta property="og:url" content="http://localhost:4000/R/vignettes/Forked-extra-current/backup-code/intro-spatial-on-6th/" />
  <link rel="canonical" href="http://localhost:4000/R/vignettes/Forked-extra-current/backup-code/intro-spatial-on-6th/" />
  

  
  <meta property="og:image" content="http://localhost:4000/img/centre-logo-white.jpg" />
  


  <!-- Twitter summary cards -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <meta name="twitter:creator" content="@" />

  
  <meta name="twitter:title" content="Introduction" />
  

  
  <meta name="twitter:description" content="Introduction ======================================================== This tutorial is an &quot;Introduction to Spatial Data and ggplot2&quot; and assumes no prior knowledge of spatial data analysis in R. We do recommend users are acquainted with the R command line before beginning the practicals though, perhaps via an 'Introduction to R' type tutorial, such as &quot;A...">
  

  
  <meta name="twitter:image" content="http://localhost:4000/img/centre-logo-white.jpg" />
  

  

  

</head>

  
  <body>

    

  
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
        <a class="navbar-brand" href="http://localhost:4000">Creating maps in R</a>
      
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
          <li>
            






<a href="/Creating-maps-in-R/Creating-maps-in-R">Home</a>

          </li>
        
        
        
          <li class="navlinks-container">
            <a class="navlinks-parent" href="javascript:void(0)">Info</a>
            <div class="navlinks-children">
              
                
                  






<a href="https://www.ssnhub.com/cv-ard">CV(draft only)</a>

                
              
            </div>
          </li>
        
        
      </ul>
    </div>

	
	<div class="avatar-container">
	  <div class="avatar-img-border">
	    <a href="http://localhost:4000">
	      <img class="avatar-img" src="/Creating-maps-in-R/img/centre-logo-white.jpg" />
		</a>
	  </div>
	</div>
	

  </div>
</nav>


    <!-- TODO this file has become a mess, refactor it -->





<header class="header-section ">

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-heading">
          <h1>Introduction</h1>
		  
		  
		  
        </div>
      </div>
    </div>
  </div>
</div>
</header>





<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <h1 id="introduction">Introduction</h1>

<p>This tutorial is an “Introduction to Spatial Data and ggplot2” and assumes no prior knowledge of spatial data analysis  in R. 
We do recommend users are acquainted with the R command line
before beginning the practicals though,
perhaps via an ‘Introduction to R’ type tutorial, such as
“A (very) short introduction to R” (Torfs and Brauer, 2012) or the more 
geographically inclined “Short introduction to R” (Harris, 2012).</p>

<p>Building on such background material, 
the following set of exercises is concerned with specific functions for spatial data and also the use of a package called ggplot2 for data visualisation.
An up-to-date version of this document is maintained at 
<a href="https://github.com/Robinlovelace/Creating-maps-in-R/blob/master/intro-spatial-rl.pdf">https://github.com/Robinlovelace/Creating-maps-in-R</a>. Suggested improvements welcome.</p>

<h2 id="typographic-conventions">Typographic conventions</h2>

<p>To ensure reproducibility and allow automatic syntax highlighting, 
this document has been written in RMarkdown. 
Be aware of the following typographic conventions: R code (e.g. <code class="highlighter-rouge">plot(x, y)</code>) is
written in a <code class="highlighter-rouge">monospace</code> font while prose is not. Blocks of code such as,</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="o">^</span><span class="m">2</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## [1]  1  4  9 25</code></pre></figure>

<p>are compiled in-line: the <code class="highlighter-rouge">##</code> indicates this is output from R. Some of the 
output from the code below is quite long; we only show the output that is 
useful. A single hash (<code class="highlighter-rouge">#</code>) is a comment for humans to read that R will ignore.
All images in this document are small and low-quality to save space; they should 
display better on your computer screen and can be saved at any resolution.
The code presented here is not the only way to do things: we encourage you to 
play with it and try things out to gain a deeper understanding of R.
Don’t worry, you cannot ‘break’ anything using R and all the input data 
can be re-loaded if things do go wrong.</p>

<h2 id="prerequisites-and-packages">Prerequisites and packages</h2>

<p>For this tutorial you need to install R, the latest version of which 
can be downloaded from <a href="http://cran.r-project.org/">http://cran.r-project.org/</a>.
A number of R editors such as <a href="http://www.rstudio.com/">RStudio</a>
can be used to make R more user friendly, 
but these are not needed to complete the tutorial.</p>

<p>R has a huge and growing number of spatial data packages. 
These can be
installed in one go with the <code class="highlighter-rouge">ctv</code> package and the command <code class="highlighter-rouge">install.views("Spatial")</code>.
We do NOT recommend running this command for this tutorial: partly because
downloading and compiling all spatial packages takes 
a long time (hundreds of megabytes)
and also because we will add new packages when they are needed 
to see what each does. We do recommend taking a quick browse at the range of 
spatial packages on offer though: 
<a href="http://cran.r-project.org/web/views/Spatial.html">http://cran.r-project.org/web/views/Spatial.html</a>.</p>

<p>The packages we will be using are <code class="highlighter-rouge">ggplot2</code>, <code class="highlighter-rouge">rgdal</code>, <code class="highlighter-rouge">rgeos</code>, <code class="highlighter-rouge">maptools</code> and <code class="highlighter-rouge">ggmap</code>.
To test whether ggplot2 is installed, for example, enter <code class="highlighter-rouge">library(ggpot2)</code>. 
If you get an error message, it needs to be installed: <code class="highlighter-rouge">install.packages("ggplot2")</code>.</p>

<p>All of the data used for the tutorial can be downloaded from here:</p>

<p>https://www.dropbox.com/sh/0z9a0hrn72poql5/Bx3rgWZ0kN</p>

<p>Save this to a new folder, then in R specify the path of that folder as you working directory. Use the <code class="highlighter-rouge">setwd</code> command to do this.
If your username is “username” and you saved the files into a 
folder called “rmapping” on your Desktop, for example, 
you would type the following:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">setwd</span><span class="p">(</span><span class="s2">"C:/Users/username/Desktop/rmapping/R"</span><span class="p">)</span></code></pre></figure>

<p>If you are working in RStudio, you can create a project that will automatically 
set your working directory.</p>

<h2 id="loading-spatial-data">Loading spatial data</h2>

<p>One of the most important steps in handling spatial data with R 
is the ability to read in shapefiles. There are a number of ways to do this. 
The most simple is <code class="highlighter-rouge">readShapePoly()</code> in the <code class="highlighter-rouge">maptools</code> package:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">maptools</span><span class="p">)</span><span class="w"> </span><span class="c1"># load the package</span><span class="w">
</span><span class="n">sport</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">readShapePoly</span><span class="p">(</span><span class="s2">"london_sport.shp"</span><span class="p">)</span><span class="w"> </span><span class="c1"># read in the shapefile</span></code></pre></figure>

<p>This method works OK, but it is no longer considered best 
practice since it doesn’t load in the spatial referencing information 
etc associated with the shapefile.
A more powerful way to read in geographical data is to use the <code class="highlighter-rouge">rgdal</code> function 
<code class="highlighter-rouge">readOGR</code>, which automatically extracts this information.
This is R’s interface to the “Geospatial Abstraction Library (GDAL)”
which is used by other open source GIS packages such as QGIS and enables 
R to handle a broader range of spatial data formats.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">rgdal</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in library(rgdal): there is no package called 'rgdal'</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">sport</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">readOGR</span><span class="p">(</span><span class="n">dsn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"."</span><span class="p">,</span><span class="w"> </span><span class="s2">"london_sport"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in readOGR(dsn = ".", "london_sport"): could not find function "readOGR"</code></pre></figure>

<p>In the code above <code class="highlighter-rouge">dsn</code> is an <em>argument</em> of the <em>function</em> <code class="highlighter-rouge">readOGR</code>. 
R functions have a default order of functions, so <code class="highlighter-rouge">dsn = </code> does not 
actually need to be typed: <code class="highlighter-rouge">readOGR(".", "london_sport")</code> works the same, but
it is good to remember the meaning of each argument when beginning to use R, so 
we sometimes include argument names when it is relevant. Here, <code class="highlighter-rouge">dsn</code>
stands for “data source name” which is the folder containing the spatial data – this was pre-specified when you set your working directory. The next argument is a 
<em>character string</em>, text identifying the file required. 
There is no need to add a file extension.</p>

<p>The file contains the borough population and 
the percentage of the population engaging in sporting activities and was taken from the 
<a href="http://data.london.gov.uk/datastore/package/active-people-survey-kpi-data-borough">active people survey</a>.
The boundary data is from the <a href="http://www.ordnancesurvey.co.uk/oswebsite/opendata/">Ordnance Survey</a>.</p>

<p>All shapefiles have an attribute table. This is loaded with <code class="highlighter-rouge">readOGR</code> and can be treated in a similar way to an R <a href="http://www.statmethods.net/input/datatypes.html">data frame</a>.</p>

<p>R hides the geometry of spatial data unless you print the object (using the <code class="highlighter-rouge">print()</code>). 
Let’s take a look at the headings of sport, using the following command: <code class="highlighter-rouge">names(sport)</code>
The data contained in spatial data are kept in a ‘slot’ that can be accessed using 
the @ symbol: <code class="highlighter-rouge">sport@data</code>. This is useful if you do not wish to work with the spatial components of the data at all times.</p>

<p>Type <code class="highlighter-rouge">summary(sport)</code> to get some additional information about the data object. Spatial objects in R contain a variety of additional information:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Object of class SpatialPolygonsDataFrame
Coordinates:
       min      max
x 503571.2 561941.1
y 155850.8 200932.5
Is projected: TRUE 
proj4string :
[+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 ....]
</code></pre></div></div>

<p>In the above code <code class="highlighter-rouge">proj4string</code> represents the coordinate reference system used in the data. 
In this file it has been incorrectly specified so we can change it with the following:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">proj4string</span><span class="p">(</span><span class="n">sport</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">CRS</span><span class="p">(</span><span class="s2">"+init=epsg:27700"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in CRS("+init=epsg:27700"): could not find function "CRS"</code></pre></figure>

<p>You will see you get a warning. This is simply saying that you are changing 
the coordinate reference system, not reprojecting the data. 
Epsg:27700 is the code for British National Grid.
If we wanted to reproject the data into something 
like WGS84 for latitude and longitude we would use the following code:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">sport.wgs84</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">spTransform</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span><span class="w"> </span><span class="n">CRS</span><span class="p">(</span><span class="s2">"+init=epsg:4326"</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in spTransform(sport, CRS("+init=epsg:4326")): could not find function "spTransform"</code></pre></figure>

<p>The different epsg codes are a bit of hassle to remember but you can find them all at 
<a href="http://spatialreference.org/">spatialreference.org</a>.</p>

<h1 id="ggplot2">ggplot2</h1>

<p>This next section of the practical introduces a slightly different method of creating plots in R using the ggplot2 
package. The package is an implementation of the Grammar of Graphics (Wilkinson 2005) - 
a general scheme for data visualization that breaks up graphs into semantic components such as scales and layers. 
ggplot2 can serve as a replacement for the base graphics in R (the functions you have been plotting with today) and contains a number of default options that match good visualisation practice.</p>

<p>The maps we produce will not be that meaningful - 
the focus here is on sound visualisation with R and not sound analysis 
(obviously the value of the former diminished in the absence of the latter!)
Whilst the instructions are step by step you are encouraged to deviate from them 
(trying different colours for example) to get a better understanding 
of what we are doing.</p>

<p><code class="highlighter-rouge">ggplot2</code> is one of the best documented packages in R. 
The full documentation for it can be found online and it is recommended you 
test out the examples on your own machines and play with them: 
http://docs.ggplot2.org/current/ .</p>

<p>Good examples of graphs can also be found on the website 
<a href="http://www.cookbook-r.com/Graphs/">cookbook-r.com</a>.</p>

<p>Load the package:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Registered S3 methods overwritten by 'ggplot2':
##   method         from 
##   [.quosures     rlang
##   c.quosures     rlang
##   print.quosures rlang</code></pre></figure>

<p>It is worth noting that the basic <code class="highlighter-rouge">plot()</code> function requires no 
data preparation but additional effort in colour selection/adding the map key etc. 
<code class="highlighter-rouge">qplot()</code> and <code class="highlighter-rouge">ggplot()</code> (from the ggplot2 package) 
require some additional steps to format the spatial data but select 
colours and add keys etc automatically. More on this later.</p>

<p>As a first attempt with ggplot2 we can create a scatter plot with the attribute data in the sport object created above. Type:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">sport</span><span class="o">@</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">Partic_Per</span><span class="p">,</span><span class="w"> </span><span class="n">Pop_2001</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in ggplot(sport@data, aes(Partic_Per, Pop_2001)): object 'sport' not found</code></pre></figure>

<p>What you have just done is set up a ggplot object where 
you say where you want the input data to come from. 
<code class="highlighter-rouge">sport@data</code> is actually a data frame contained within the 
wider spatial object <code class="highlighter-rouge">sport</code> (the <code class="highlighter-rouge">@</code> enables you to
access the attribute table of the 
sport shapefile).  The characters inside the <code class="highlighter-rouge">aes</code> argument
refer to the parts of that data frame you wish to use (the variables <code class="highlighter-rouge">Partic_Per</code> and <code class="highlighter-rouge">Pop_2001</code>).
This has to happen within the brackets of <code class="highlighter-rouge">aes()</code>, which means, 
roughly speaking ‘aesthetics that vary’.<br />
If you just type p and hit enter you get the error <code class="highlighter-rouge">No layers in plot</code>. 
This is because you have not told ggplot what you want 
to do with the data. We do this by adding so-called “geoms”, 
in this case <code class="highlighter-rouge">geom_point()</code>.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_point</span><span class="p">()</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'p' not found</code></pre></figure>

<p>Within the brackets you can alter the nature of the points. Try something like <code class="highlighter-rouge">p + geom_point(colour = "red", size=2)</code> and experiment.</p>

<p>If you want to scale the points by borough population and colour them by sports participation this is also fairly easy by adding another <code class="highlighter-rouge">aes()</code> argument.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="n">Partic_Per</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="n">Pop_2001</span><span class="p">))</span></code></pre></figure>

<p>The real power of ggplot2 lies in its ability to add layers to a plot. In this case we can add text to the plot.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Partic_Per</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pop_2001</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'p' not found</code></pre></figure>

<p>This idea of layers (or geoms) is quite different from the standard plot functions in R, but you will find that each of the functions  does a lot of clever stuff to make plotting much easier (see the documentation for a full list).</p>

<p>The following steps will create a map to show the percentage of the population in each London Borough who regularly participate in sports activities.</p>

<p>To get the shapefiles into a format that can be plotted we have to use the <code class="highlighter-rouge">fortify()</code> function. Spatial objects in R have a number of slots containing the various items of data (polygon geometry, projection, attribute information) associated with a shapefile. Slots can be thought of as shelves within the data object that contain the different attributes. The “polygons” slot contains the geometry of the polygons in the form of the XY coordinates used to draw the polygon outline. The generic plot function can work out what to do with these, ggplot2 cannot. We therefore need to extract them as a data frame. The fortify function was written specifically for this purpose.
For this to work, either <code class="highlighter-rouge">gpclib</code> or <code class="highlighter-rouge">rgeos</code> packages must be installed.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># library(gpclib); gpclibPermit() # uncomment if rgeos not installed</span><span class="w">
</span><span class="n">sport.f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fortify</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span><span class="w"> </span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ons_label"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in fortify(sport, region = "ons_label"): object 'sport' not found</code></pre></figure>

<p>This step has lost the attribute information associated with the sport object. We can add it back using the merge function (this performs a data join). To find out how this function works look at 
the output of typing <code class="highlighter-rouge">?merge</code>.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">sport.f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">sport.f</span><span class="p">,</span><span class="w"> </span><span class="n">sport</span><span class="o">@</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">by.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"id"</span><span class="p">,</span><span class="w"> </span><span class="n">by.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ons_label"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in merge(sport.f, sport@data, by.x = "id", by.y = "ons_label"): object 'sport.f' not found</code></pre></figure>

<p>Take a look at the <code class="highlighter-rouge">sport.f</code> object to see its contents.  You should see a large data frame containing the latitude and longitude (they are actually Easting and Northing as the data are in British National Grid format) coordinates alongside the attribute information associated with each London Borough. If you type <code class="highlighter-rouge">print(sport.f)</code> you will just how many coordinate pairs are required!
To keep the output to a minimum, take a peak at the object just using the <code class="highlighter-rouge">head</code> command:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">head</span><span class="p">(</span><span class="n">sport.f</span><span class="p">[,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">8</span><span class="p">])</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in head(sport.f[, 1:8]): object 'sport.f' not found</code></pre></figure>

<p>It is now straightforward to produce a map using all the built in tools 
(such as setting the breaks in the data) that ggplot2 has to offer. 
<code class="highlighter-rouge">coord_equal()</code> is the equivalent of asp=T in regular plots with R:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">Map</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">sport.f</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Partic_Per</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_polygon</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">coord_equal</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Easting (m)"</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Northing (m)"</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"% Sport Partic."</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"London Sports Participation"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in ggplot(sport.f, aes(long, lat, group = group, fill = Partic_Per)): object 'sport.f' not found</code></pre></figure>

<p>Now, just typing <code class="highlighter-rouge">Map</code> should result in your first ggplot-made map of London!
There is a lot going on in the code above, so think about it line by line:
what has each of the elements of code above has been designed to do. 
Also note how the <code class="highlighter-rouge">aes()</code> components can be combined into one set of brackets 
after <code class="highlighter-rouge">ggplot</code>, that has relevance for all layers, rather than being
broken into separate parts as we did above. 
The different plot functions still know what to do with these. 
The <code class="highlighter-rouge">group=group</code> points ggplot to the group column added by 
<code class="highlighter-rouge">fortify()</code> and it identifies the groups of coordinates that pertain 
to individual polygons (in this case London Boroughs).</p>

<p>The default colours are really nice but we may wish to produce the map in black and white, 
which should produce a map like that shown below:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">Map</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">scale_fill_gradient</span><span class="p">(</span><span class="n">low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">,</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## NULL</code></pre></figure>

<p>Saving plot images is also easy. You just need to use <code class="highlighter-rouge">ggsave</code> after each plot, e.g.
<code class="highlighter-rouge">ggsave("my_map.pdf")</code> will save the map as a pdf, with default settings. For 
a larger map, you could try the following:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">ggsave</span><span class="p">(</span><span class="s2">"my_large_plot.png"</span><span class="p">,</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">dpi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">400</span><span class="p">)</span></code></pre></figure>

<h1 id="adding-base-maps-to-ggplot2-with-ggmap">Adding base maps to ggplot2 with ggmap</h1>

<p>ggmap is a package that uses the ggplot2 syntax as a 
template to create maps with image tiles from the likes of Google and OpenStreetMap:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">ggmap</span><span class="p">)</span><span class="w"> </span><span class="c1"># you may have to use install.packages to install it first</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in library(ggmap): there is no package called 'ggmap'</code></pre></figure>

<p>The sport object is in British National Grid but the ggmap 
image tiles are in WGS84. We therefore need to use the sport.wgs84 
object created in the reprojection operation earlier.</p>

<p>The first job is to calculate the bounding box (bb for short) of the 
sport.wgs84 object to identify the geographic extent of the image tiles that we need.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">b</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">bbox</span><span class="p">(</span><span class="n">sport.wgs84</span><span class="p">)</span><span class="w"> </span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in bbox(sport.wgs84): could not find function "bbox"</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">b</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="p">]))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1.05</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="p">])</span><span class="w"> </span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'b' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">b</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="p">]))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1.05</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="p">])</span><span class="w"> </span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'b' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># scale longitude and latitude (increase bb by 5% for plot)</span><span class="w">
</span><span class="c1"># replace 1.05 with 1.xx for an xx% increase in the plot size</span></code></pre></figure>

<p>This is then fed into the <code class="highlighter-rouge">get_map</code> function as the location parameter. The syntax below contains 2 functions. <code class="highlighter-rouge">ggmap</code> is required to produce the plot and provides the base map data.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">lnd.b1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggmap</span><span class="p">(</span><span class="n">get_map</span><span class="p">(</span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in ggmap(get_map(location = b)): could not find function "ggmap"</code></pre></figure>

<p>In much the same way as we did above we can then layer the plot with different geoms.</p>

<p>First fortify the sport.wgs84 object and then merge with the required attribute
data (we already did this step to create the sport.f object).</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">sport.wgs84.f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fortify</span><span class="p">(</span><span class="n">sport.wgs84</span><span class="p">,</span><span class="w"> </span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ons_label"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in fortify(sport.wgs84, region = "ons_label"): object 'sport.wgs84' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">sport.wgs84.f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">sport.wgs84.f</span><span class="p">,</span><span class="w"> </span><span class="n">sport.wgs84</span><span class="o">@</span><span class="n">data</span><span class="p">,</span><span class="w"> 
                      </span><span class="n">by.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"id"</span><span class="p">,</span><span class="w"> </span><span class="n">by.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ons_label"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in merge(sport.wgs84.f, sport.wgs84@data, by.x = "id", by.y = "ons_label"): object 'sport.wgs84.f' not found</code></pre></figure>

<p>We can now overlay this on our base map.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">lnd.b1</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_polygon</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sport.wgs84.f</span><span class="p">,</span><span class="w"> 
               </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Partic_Per</span><span class="p">),</span><span class="w"> 
               </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">)</span></code></pre></figure>

<p>The code above contains a lot of parameters. Use the ggplot2 help pages to find out what they are. 
The resulting map looks okay, but it would be improved with a simpler base map in black and white. 
A design firm called stamen provide the tiles we need and they can be brought into the 
plot with the <code class="highlighter-rouge">get_map</code> function:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">lnd.b2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggmap</span><span class="p">(</span><span class="n">get_map</span><span class="p">(</span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"stamen"</span><span class="p">,</span><span class="w"> 
                        </span><span class="n">maptype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"toner"</span><span class="p">,</span><span class="w"> </span><span class="n">crop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in ggmap(get_map(location = b, source = "stamen", maptype = "toner", : could not find function "ggmap"</code></pre></figure>

<p>We can then produce the plot as before.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">lnd.b2</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_polygon</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sport.wgs84.f</span><span class="p">,</span><span class="w"> 
               </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Partic_Per</span><span class="p">),</span><span class="w">
               </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">)</span></code></pre></figure>

<p>Finally, if we want to increase the detail of the base map, get_map has a zoom parameter.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">lnd.b3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggmap</span><span class="p">(</span><span class="n">get_map</span><span class="p">(</span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"stamen"</span><span class="p">,</span><span class="w"> </span><span class="n">maptype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"toner"</span><span class="p">,</span><span class="w"> </span><span class="n">crop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">zoom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">11</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in ggmap(get_map(location = b, source = "stamen", maptype = "toner", : could not find function "ggmap"</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">lnd.b3</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_polygon</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sport.wgs84.f</span><span class="p">,</span><span class="w"> 
               </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Partic_Per</span><span class="p">),</span><span class="w"> 
               </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'lnd.b3' not found</code></pre></figure>

<h1 id="joining-and-clipping">Joining and clipping</h1>

<p>This section builds on the previous information on plotting and highlights 
some of R’s more advanced spatial functions from the <code class="highlighter-rouge">rgeos</code> package. 
We look at joining new 
datasets to our data - an attribute join - spatial joins, whereby 
data is added to the target layer depending on the location of the 
origins and clipping.</p>

<p>To reaffirm our starting point, let’s re-plot the only 
spatial dataset in our workspace, and count the number
of polygons:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">rgdal</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in library(rgdal): there is no package called 'rgdal'</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">lnd</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">readOGR</span><span class="p">(</span><span class="n">dsn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"."</span><span class="p">,</span><span class="w"> </span><span class="s2">"london_sport"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in readOGR(dsn = ".", "london_sport"): could not find function "readOGR"</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">plot</span><span class="p">(</span><span class="n">lnd</span><span class="p">);</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">lnd</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in plot(lnd): object 'lnd' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in nrow(lnd): object 'lnd' not found</code></pre></figure>

<h2 id="downloading-additional-data">Downloading additional data</h2>

<p>Because we are using borough-level data, and boroughs are official administrative
zones, there is much data available at this level. We will use the example 
of crime data to illustrate this data availability, and join this with the current 
spatial dataset. As before, we can download and import the data from within R:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># download.file("http://data.london.gov.uk/datafiles/crime-community-safety/mps-</span><span class="w">
</span><span class="c1"># recordedcrime-borough.csv", destfile = "mps-recordedcrime-borough.csv")</span><span class="w">
</span><span class="c1"># uncomment and join the above code to download the data</span><span class="w">

</span><span class="n">crimeDat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"mps-recordedcrime-borough.csv"</span><span class="p">)</span><span class="w"> </span><span class="c1"># flags an error</span></code></pre></figure>

<p>Initially, the <code class="highlighter-rouge">read.csv</code> command flags an error: open the raw .csv file in a 
text editor such as Notepad, Notepad++ or GVIM, find the problem and correct it.
Alternatively, you can work out what the file encoding is and use the correct 
argument (this is not recommended - simpler just to edit the text file
in most cases).</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">crimeDat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"mps-recordedcrime-borough.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">fileEncoding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UCS-2LE"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Warning in file(file, "rt", encoding = fileEncoding): cannot open file
## 'mps-recordedcrime-borough.csv': No such file or directory</code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in file(file, "rt", encoding = fileEncoding): cannot open the connection</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">head</span><span class="p">(</span><span class="n">crimeDat</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in head(crimeDat): object 'crimeDat' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">summary</span><span class="p">(</span><span class="n">crimeDat</span><span class="o">$</span><span class="n">MajorText</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in summary(crimeDat$MajorText): object 'crimeDat' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">crimeTheft</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">crimeDat</span><span class="p">[</span><span class="n">which</span><span class="p">(</span><span class="n">crimeDat</span><span class="o">$</span><span class="n">MajorText</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Theft &amp; Handling"</span><span class="p">),</span><span class="w"> </span><span class="p">]</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'crimeDat' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">head</span><span class="p">(</span><span class="n">crimeTheft</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="c1"># change 2 for more rows</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in head(crimeTheft, 2): object 'crimeTheft' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">crimeAg</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">aggregate</span><span class="p">(</span><span class="n">CrimeCount</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">Spatial_DistrictName</span><span class="p">,</span><span class="w"> </span><span class="n">FUN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"sum"</span><span class="p">,</span><span class="w"> 
                     </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crimeTheft</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(m$data, parent.frame()): object 'crimeTheft' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">head</span><span class="p">(</span><span class="n">crimeAg</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="c1"># show the aggregated crime data</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in head(crimeAg, 2): object 'crimeAg' not found</code></pre></figure>

<p>Now that we have crime data at the borough level, the challenge is to join it
by name. This is not always straightforward. Let us see which names in the 
crime data match the spatial data:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">lnd</span><span class="o">$</span><span class="n">name</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">crimeAg</span><span class="o">$</span><span class="n">Spatial_DistrictName</span><span class="w"> </span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in lnd$name %in% crimeAg$Spatial_DistrictName: object 'lnd' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">lnd</span><span class="o">$</span><span class="n">name</span><span class="p">[</span><span class="n">which</span><span class="p">(</span><span class="o">!</span><span class="n">lnd</span><span class="o">$</span><span class="n">name</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">crimeAg</span><span class="o">$</span><span class="n">Spatial_DistrictName</span><span class="p">)]</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'lnd' not found</code></pre></figure>

<p>The first line of code above shows that all but one of the borough names matches;
the second tells us that it is City of London that is named differently in the 
crime data. Look at the results (not shown here) on your computer.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">levels</span><span class="p">(</span><span class="n">crimeAg</span><span class="o">$</span><span class="n">Spatial_DistrictName</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in levels(crimeAg$Spatial_DistrictName): object 'crimeAg' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">levels</span><span class="p">(</span><span class="n">crimeAg</span><span class="o">$</span><span class="n">Spatial_DistrictName</span><span class="p">)[</span><span class="m">25</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> 
  </span><span class="nf">as.character</span><span class="p">(</span><span class="n">lnd</span><span class="o">$</span><span class="n">name</span><span class="p">[</span><span class="n">which</span><span class="p">(</span><span class="o">!</span><span class="n">lnd</span><span class="o">$</span><span class="n">name</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">crimeAg</span><span class="o">$</span><span class="n">Spatial_DistrictName</span><span class="p">)])</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'lnd' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">lnd</span><span class="o">$</span><span class="n">name</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">crimeAg</span><span class="o">$</span><span class="n">Spatial_DistrictName</span><span class="w"> </span><span class="c1"># now all columns match</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in lnd$name %in% crimeAg$Spatial_DistrictName: object 'lnd' not found</code></pre></figure>

<p>The above code block first identified the row with the faulty name and 
then renamed the level to match the <code class="highlighter-rouge">lnd</code> dataset. Note that we could not
rename the variable directly, as it is stored as a factor.</p>

<p>We are now ready to join the datasets. It is recommended to use 
the <code class="highlighter-rouge">join</code> function in the <code class="highlighter-rouge">plyr</code> package but the <code class="highlighter-rouge">merge</code> function 
could equally be used.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">help</span><span class="p">(</span><span class="n">join</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## starting httpd help server ... done</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">plyr</span><span class="p">)</span><span class="w">
</span><span class="n">help</span><span class="p">(</span><span class="n">join</span><span class="p">)</span><span class="w"> </span><span class="c1"># now help should appear</span></code></pre></figure>

<p>The documentation for join will be displayed if the plyr package is loaded (if not,
load or install and load it!). It requires all joining variables to have the 
same name, so we will rename the variable to make the join work:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">head</span><span class="p">(</span><span class="n">lnd</span><span class="o">$</span><span class="n">name</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in head(lnd$name): object 'lnd' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">head</span><span class="p">(</span><span class="n">crimeAg</span><span class="o">$</span><span class="n">Spatial_DistrictName</span><span class="p">)</span><span class="w"> </span><span class="c1"># the variables to join</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in head(crimeAg$Spatial_DistrictName): object 'crimeAg' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">crimeAg</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rename</span><span class="p">(</span><span class="n">crimeAg</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Spatial_DistrictName"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"name"</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in revalue(names(x), replace, warn_missing = warn_missing): object 'crimeAg' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">head</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">lnd</span><span class="o">@</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">crimeAg</span><span class="p">))</span><span class="w"> </span><span class="c1"># test it works</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in as.vector(y): object 'crimeAg' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">lnd</span><span class="o">@</span><span class="n">data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">join</span><span class="p">(</span><span class="n">lnd</span><span class="o">@</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">crimeAg</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in as.vector(y): object 'crimeAg' not found</code></pre></figure>

<h2 id="adding-point-data-for-clipping-and-spatial-join">Adding point data for clipping and spatial join</h2>
<p>In addition to joining by zone name, it is also possible to do
<a href="http://help.arcgis.com/en/arcgisdesktop/10.0/help/index.html#//00080000000q000000">spatial joins</a> in R. There are three main varieties: many-to-one - where
the values of many intersecting objects contribute to a new variable in 
the main table - one-to-many, or one-to-one. Because boroughs in London 
are quite large, we will conduct a many-to-one spatial join.
We will be using Tube Stations as the spatial data to join, 
with the aim of finding out which and how many stations
are found in each London borough.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">download.file</span><span class="p">(</span><span class="s2">"http://www.personal.leeds.ac.uk/~georl/egs/lnd-stns.zip"</span><span class="p">,</span><span class="w"> 
              </span><span class="s2">"lnd-stns.zip"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Warning in download.file("http://www.personal.leeds.ac.uk/~georl/egs/
## lnd-stns.zip", : cannot open URL 'http://www.personal.leeds.ac.uk/
## ~georl/egs/lnd-stns.zip': HTTP status was '404 Not Found'</code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in download.file("http://www.personal.leeds.ac.uk/~georl/egs/lnd-stns.zip", : cannot open URL 'http://www.personal.leeds.ac.uk/~georl/egs/lnd-stns.zip'</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">unzip</span><span class="p">(</span><span class="s2">"lnd-stns.zip"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Warning in unzip("lnd-stns.zip"): error 1 in extracting from zip file</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">rgdal</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in library(rgdal): there is no package called 'rgdal'</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">stations</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">readOGR</span><span class="p">(</span><span class="n">dsn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"."</span><span class="p">,</span><span class="w"> </span><span class="n">layer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"lnd-stns"</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="m">4</span><span class="n">s</span><span class="o">=</span><span class="s2">"+init=epsg:27700"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in readOGR(dsn = ".", layer = "lnd-stns", p4s = "+init=epsg:27700"): could not find function "readOGR"</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">proj4string</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span><span class="w"> </span><span class="c1"># this is the full geographical detail.</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in proj4string(stations): could not find function "proj4string"</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">proj4string</span><span class="p">(</span><span class="n">lnd</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in proj4string(lnd): could not find function "proj4string"</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">bbox</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in bbox(stations): could not find function "bbox"</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">bbox</span><span class="p">(</span><span class="n">lnd</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in bbox(lnd): could not find function "bbox"</code></pre></figure>

<p>The above code loads the data correctly, but also shows that 
there are problems with it: the Coordinate Reference System (CRS)
differs from that of our shapefile. 
Although OSGB 1936 (or EPSG 27700) is the ‘correct’ CRS for the UK, 
we will convert the stations dataset into lat-long coordinates, 
as this is a more common CRS and enables easy base map creation:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">stationsWGS</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">spTransform</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span><span class="w"> </span><span class="n">CRSobj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CRS</span><span class="p">(</span><span class="n">proj4string</span><span class="p">(</span><span class="n">lnd</span><span class="p">)))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in spTransform(stations, CRSobj = CRS(proj4string(lnd))): could not find function "spTransform"</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">stations</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">stationsWGS</span><span class="p">;</span><span class="w"> </span><span class="n">rm</span><span class="p">(</span><span class="n">stationsWGS</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'stationsWGS' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Warning in rm(stationsWGS): object 'stationsWGS' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">plot</span><span class="p">(</span><span class="n">lnd</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in plot(lnd): object 'lnd' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">points</span><span class="p">(</span><span class="n">stations</span><span class="p">[</span><span class="n">sample</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">stations</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500</span><span class="p">),])</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in points(stations[sample(1:nrow(stations), size = 500), ]): object 'stations' not found</code></pre></figure>

<p>Now we can clearly see that the stations overlay the boroughs.
The problem is that the stations dataset is far more extensive than
London borough dataset; we need</p>

<h2 id="clipping">Clipping</h2>
<p>There are a number of functions that we can use to clip the points
so that only those falling within London boroughs are retained:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>?overlay
?sp::over
library(rgeos)
?rgeos::gIntersects
</code></pre></div></div>
<p>We can write off the first one straight away as it is depreciated by the second. 
It seems that <code class="highlighter-rouge">gIntersects</code> can produce the same output as <code class="highlighter-rouge">over</code>, based 
on <a href="http://gis.stackexchange.com/questions/63793/how-to-overlay-a-polygon-over-spatialpointsdataframe-and-preserving-the-spdf-dat">discussion</a> 
in the community,  so either 
can be used. (See this 
<a href="http://stackoverflow.com/questions/15881455/how-to-clip-worldmap-with-polygon-in-r">discussion</a>
for further alternatives.) 
In this tutorial we will use <code class="highlighter-rouge">gIntersects</code>,
for clipping although we could equally use 
<code class="highlighter-rouge">gContains</code>, <code class="highlighter-rouge">gWithin</code> and other <code class="highlighter-rouge">g...</code> functions -
see rgeos help pages by typing <code class="highlighter-rouge">?gOverlaps</code> or other functions for more.
<code class="highlighter-rouge">gIntersects</code> will output information for each point, telling us which 
polygon it interacts with (i.e. the polygon it is in):</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">int</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gIntersects</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span><span class="w"> </span><span class="n">lnd</span><span class="p">,</span><span class="w"> </span><span class="n">byid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w"> </span><span class="c1"># find which stations intersect </span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in gIntersects(stations, lnd, byid = T): could not find function "gIntersects"</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="nf">class</span><span class="p">(</span><span class="n">int</span><span class="p">)</span><span class="w"> </span><span class="c1"># it's outputed a matrix</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'int' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="nf">dim</span><span class="p">(</span><span class="n">int</span><span class="p">)</span><span class="w"> </span><span class="c1"># with 33 rows (one for each zone) and 2532 cols (the points)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'int' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">summary</span><span class="p">(</span><span class="n">int</span><span class="p">[,</span><span class="nf">c</span><span class="p">(</span><span class="m">200</span><span class="p">,</span><span class="m">500</span><span class="p">)])</span><span class="w"> </span><span class="c1"># not the output of this</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in summary(int[, c(200, 500)]): object 'int' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">plot</span><span class="p">(</span><span class="n">lnd</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in plot(lnd): object 'lnd' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">points</span><span class="p">(</span><span class="n">stations</span><span class="p">[</span><span class="m">200</span><span class="p">,],</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"red"</span><span class="p">)</span><span class="w"> </span><span class="c1"># note point id 200 is outside the zones</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in points(stations[200, ], col = "red"): object 'stations' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">points</span><span class="p">(</span><span class="n">stations</span><span class="p">[</span><span class="m">500</span><span class="p">,],</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"green"</span><span class="p">)</span><span class="w"> </span><span class="c1"># note point 500 is inside</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in points(stations[500, ], col = "green"): object 'stations' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">which</span><span class="p">(</span><span class="n">int</span><span class="p">[,</span><span class="m">500</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w"> </span><span class="c1"># this tells us that point 500 intersects with zone 32</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in which(int[, 500] == T): object 'int' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">points</span><span class="p">(</span><span class="n">coordinates</span><span class="p">(</span><span class="n">lnd</span><span class="p">[</span><span class="m">32</span><span class="p">,]),</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">)</span><span class="w"> </span><span class="c1"># test the previous statement</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in coordinates(lnd[32, ]): could not find function "coordinates"</code></pre></figure>

<p>In the above code, only the first line actually ‘does’ anything
in our workspace, by creating the object <code class="highlighter-rouge">int</code>. The proceeding 
lines are dedicated to exploring this object and what it means. 
Note that it is a matrix with columns corresponding to the points and 
rows corresponding to boroughs. The borough in which a particular 
point can be extracted from <code class="highlighter-rouge">int</code> as we shall see below.
For the purposes of clipping, we are only interested in whether
the point intersects with <em>any</em> of the boroughs. This is where the 
function <code class="highlighter-rouge">apply</code>, which is unique to R, comes into play:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">clipped</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">apply</span><span class="p">(</span><span class="n">int</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">F</span><span class="p">,</span><span class="w"> </span><span class="n">MARGIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">all</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in apply(int == F, MARGIN = 2, all): object 'int' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">plot</span><span class="p">(</span><span class="n">stations</span><span class="p">[</span><span class="n">which</span><span class="p">(</span><span class="n">clipped</span><span class="p">),])</span><span class="w"> </span><span class="c1"># shows all stations we DO NOT want</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in plot(stations[which(clipped), ]): object 'stations' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">stations.cl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">stations</span><span class="p">[</span><span class="n">which</span><span class="p">(</span><span class="o">!</span><span class="n">clipped</span><span class="p">),]</span><span class="w"> </span><span class="c1"># use ! to select the invers</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'stations' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">points</span><span class="p">(</span><span class="n">stations.cl</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"green"</span><span class="p">)</span><span class="w"> </span><span class="c1"># check that it's worked</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in points(stations.cl, col = "green"): object 'stations.cl' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">stations</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">stations.cl</span><span class="p">;</span><span class="w"> </span><span class="n">rm</span><span class="p">(</span><span class="n">stations.cl</span><span class="p">)</span><span class="w"> </span><span class="c1"># tidy up: we're only interested in clipped ones</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'stations.cl' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Warning in rm(stations.cl): object 'stations.cl' not found</code></pre></figure>

<p>The first line instructs R to look at each column (<code class="highlighter-rouge">MARGIN = 2</code>, we would use
<code class="highlighter-rouge">MARGIN = 1</code> for row-by-row analysis) and report back whether <code class="highlighter-rouge">all</code> of the values are
false. This creates the inverse selection that we want, hence the use of <code class="highlighter-rouge">!</code> to invert it.
We test that the function works on a new object (often a good idea, to avoid overwriting 
useful data) with plots and, once content that the clip has worked, save the sample of 
points to our main <code class="highlighter-rouge">stations</code> object and remove the now duplicated <code class="highlighter-rouge">stations.cl</code> object.</p>

<h2 id="aggregating-the-data-to-complete-the-spatial-join">Aggregating the data to complete the spatial join</h2>

<p>Now that we know how <code class="highlighter-rouge">gIntersects</code> works in general terms and for clipping, 
let’s use it to 
allocate a borough to each of our station points, which we will then 
aggregate up. Data from these points (e.g. counts, averages in each area etc.)
can then be transferred to the main polygons table: the essence of a spatial 
join. Again, <code class="highlighter-rouge">apply</code> is our friend in this instance, meaning we can avoid <code class="highlighter-rouge">for</code> loops:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">int</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gIntersects</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span><span class="w"> </span><span class="n">lnd</span><span class="p">,</span><span class="w"> </span><span class="n">byid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w"> </span><span class="c1"># re-run the intersection query </span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in gIntersects(stations, lnd, byid = T): could not find function "gIntersects"</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">head</span><span class="p">(</span><span class="n">apply</span><span class="p">(</span><span class="n">int</span><span class="p">,</span><span class="w"> </span><span class="n">MARGIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">FUN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">which</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in apply(int, MARGIN = 2, FUN = which): object 'int' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">b.indexes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">int</span><span class="p">,</span><span class="w"> </span><span class="n">arr.ind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in which(int, arr.ind = T): object 'int' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">summary</span><span class="p">(</span><span class="n">b.indexes</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in summary(b.indexes): object 'b.indexes' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">b.names</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lnd</span><span class="o">$</span><span class="n">name</span><span class="p">[</span><span class="n">b.indexes</span><span class="p">[,</span><span class="w"> </span><span class="m">1</span><span class="p">]]</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'lnd' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">b.count</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">aggregate</span><span class="p">(</span><span class="n">b.indexes</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">b.names</span><span class="p">,</span><span class="w"> </span><span class="n">FUN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="p">)</span><span class="w"> </span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(predvars, data, env): object 'b.indexes' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">head</span><span class="p">(</span><span class="n">b.count</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in head(b.count): object 'b.count' not found</code></pre></figure>

<p>The above code first extracts the index of the row (borough) for 
which the corresponding column is true and then converts this into 
names. The final object created, <code class="highlighter-rouge">b.count</code> contains the number of station 
points in each zone. According to this, Barking and Dagenham should contain
12 station points. It is important to check the output makes sense at 
every stage with R, so let’s check to see this is indeed the case with 
a quick plot:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">plot</span><span class="p">(</span><span class="n">lnd</span><span class="p">[</span><span class="n">which</span><span class="p">(</span><span class="n">grepl</span><span class="p">(</span><span class="s2">"Barking"</span><span class="p">,</span><span class="w"> </span><span class="n">lnd</span><span class="o">$</span><span class="n">name</span><span class="p">)),])</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in plot(lnd[which(grepl("Barking", lnd$name)), ]): object 'lnd' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">points</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in points(stations): object 'stations' not found</code></pre></figure>

<p>Now the fun part: count the points in the polygon and report back how many there are!</p>

<p>The final stage is to transfer the data on station counts back into the 
polygon data frame. We have used <code class="highlighter-rouge">merge</code> to join two datasets before.
In R there is often more than one way to achieve the same result.
It’s good to experiment with different functions, so we will use
<code class="highlighter-rouge">join</code> from the <code class="highlighter-rouge">plyr</code> package. <code class="highlighter-rouge">join</code> requires identical joining 
names in both data frames, so first we will rename them (type 
<code class="highlighter-rouge">?rename</code> for more details).</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">b.count</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rename</span><span class="p">(</span><span class="n">b.count</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"b.names"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"name"</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in revalue(names(x), replace, warn_missing = warn_missing): object 'b.count' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">b.count.tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">join</span><span class="p">(</span><span class="n">lnd</span><span class="o">@</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">b.count</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in as.vector(y): object 'b.count' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">head</span><span class="p">(</span><span class="n">b.count.tmp</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in head(b.count.tmp, 2): object 'b.count.tmp' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">lnd</span><span class="o">$</span><span class="n">station.count</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">b.count.tmp</span><span class="p">[,</span><span class="w"> </span><span class="m">7</span><span class="p">]</span><span class="w"> </span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'b.count.tmp' not found</code></pre></figure>

<p>We have now seen how to join and clip data. Next, for a stronger grounding 
in how ggplot works, we will look at plotting non-spatial data.</p>

<h1 id="using-ggplot2-for-descriptive-statistics">Using ggplot2 for Descriptive Statistics</h1>

<p>For this we will use a new dataset:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">input</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"ambulance_assault.csv"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Warning in file(file, "rt"): cannot open file 'ambulance_assault.csv':
## No such file or directory</code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in file(file, "rt"): cannot open the connection</code></pre></figure>

<p>This contains the number of ambulance callouts to assault incidents (downloadable from the London DataStore) between 2009 and 2011.</p>

<p>Take a look at the contents of the file:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">head</span><span class="p">(</span><span class="n">input</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in head(input): object 'input' not found</code></pre></figure>

<p>We can now plot a histogram to show the distribution of values.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">p.ass</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assault_09_11</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in ggplot(input, aes(x = assault_09_11)): object 'input' not found</code></pre></figure>

<p>Remember the <code class="highlighter-rouge">ggplot(input, aes(x=assault_09_11))</code> section means create a generic plot object (called p.ass) from the input object using the <code class="highlighter-rouge">assault_09_11</code> column as the data for the x axis. To create the histogram you need to tell R that this is what you want to go with</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">p.ass</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_histogram</span><span class="p">()</span></code></pre></figure>

<p>The resulting message (<code class="highlighter-rouge">stat_bin: binwidth defaulted to range/30...</code>)
relates to the bins - the breaks between histogram blocks.
If you want the bins (and therefore the bars) to be thinner 
(i.e. representing fewer values) you need to make the bins 
smaller by adjusting the binwidth. Try:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">p.ass</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">binwidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_density</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">)</span><span class="w"> </span></code></pre></figure>

<p>It is also possible to overlay a density distribution over the top of the histogram. 
For this we need to produce a second plot object with the density distribution as the y variable.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">p</span><span class="m">2</span><span class="n">.ass</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assault_09_11</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">..density..</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in ggplot(input, aes(x = assault_09_11, y = ..density..)): object 'input' not found</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">p</span><span class="m">2</span><span class="n">.ass</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_histogram</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_density</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"red"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'p2.ass' not found</code></pre></figure>

<p>What kind of distribution is this plot showing? You can see that there are
a few wards with very high assault incidences (over 750). 
To find out which ones these are we can select them.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">input</span><span class="p">[</span><span class="n">which</span><span class="p">(</span><span class="n">input</span><span class="o">$</span><span class="n">assault_09_11</span><span class="o">&gt;</span><span class="m">750</span><span class="p">),]</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'input' not found</code></pre></figure>

<p>It is perhaps unsurprising that St James’s and the West End have the highest counts.
The plot has provided a good impression of the overall distribution,
but what are the characteristics of each distribution within the Boroughs?
Another type of plot that shows the core characteristics of the distribution
is a box and whisker plot. These too can be easily produced in R 
(you can’t do them in Excel!). We can create a third plot object 
(note that the assault field is now y and not x):</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">p</span><span class="m">3</span><span class="n">.ass</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Bor_Code</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assault_09_11</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in ggplot(input, aes(x = Bor_Code, y = assault_09_11)): object 'input' not found</code></pre></figure>

<p>and convert it to a boxplot.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">p</span><span class="m">3</span><span class="n">.ass</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_boxplot</span><span class="p">()</span></code></pre></figure>

<p>Perhaps this would look a little better flipped round.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">p</span><span class="m">3</span><span class="n">.ass</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_boxplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">coord_flip</span><span class="p">()</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'p3.ass' not found</code></pre></figure>

<p>Now each of the borough codes can be easily seen. 
No surprise that the Borough of Westminster (00BK) 
has the two largest outliers. In one line of code you 
have produced an incredibly complex plot rich in information. 
This demonstrates why R is such a useful program for these kinds of statistics.</p>

<p>If you want an insight into some of the visualisations you can develop with this type of data we can do faceting based on the example of the histogram plot above.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">p.ass</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_histogram</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">facet_wrap</span><span class="p">(</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">Bor_Code</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'p.ass' not found</code></pre></figure>

<p>We need to do a little bit of tweaking to make this plot publishable but we want to demonstrate that it is really easy to produce 30+ plots on a single page! Faceting is an extremely powerful way of visualizing multidimensional datasets and is especially good for showing change over time.</p>

<h1 id="advanced-task-faceting-for-maps">Advanced Task: Faceting for Maps</h1>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">reshape2</span><span class="p">)</span><span class="w"> </span><span class="c1"># this may not be installed. </span><span class="w">
</span><span class="c1"># If not install it, or skip the next two steps…</span></code></pre></figure>

<p>Load the data - this shows historic population values between 1801 and 2001 for London, again from the London data store.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">london.data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"census-historic-population-borough.csv"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Warning in file(file, "rt"): cannot open file 'census-historic-
## population-borough.csv': No such file or directory</code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in file(file, "rt"): cannot open the connection</code></pre></figure>

<p>“Melt” the data so that the columns become rows.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">london.data.melt</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">melt</span><span class="p">(</span><span class="n">london.data</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Area.Code"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Area.Name"</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in melt(london.data, id = c("Area.Code", "Area.Name")): object 'london.data' not found</code></pre></figure>

<p>Only do this step if reshape and melt failed</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">london.data.melt</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"london_data_melt.csv"</span><span class="p">)</span></code></pre></figure>

<p>Merge the population data with the London borough geometry contained within our sport.f object.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">plot.data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">sport.f</span><span class="p">,</span><span class="w"> </span><span class="n">london.data.melt</span><span class="p">,</span><span class="w"> </span><span class="n">by.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"id"</span><span class="p">,</span><span class="w"> </span><span class="n">by.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Area.Code"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in merge(sport.f, london.data.melt, by.x = "id", by.y = "Area.Code"): object 'sport.f' not found</code></pre></figure>

<p>Reorder this data (ordering is important for plots).</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">plot.data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot.data</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">plot.data</span><span class="o">$</span><span class="n">order</span><span class="p">),</span><span class="w"> </span><span class="p">]</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in eval(expr, envir, enclos): object 'plot.data' not found</code></pre></figure>

<p>We can now use faceting to produce one map per year (this may take a little while to appear).</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plot.data</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_polygon</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_path</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="s2">"grey"</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="o">=</span><span class="m">0.1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">coord_equal</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">variable</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in ggplot(data = plot.data, aes(x = long, y = lat, fill = value, : object 'plot.data' not found</code></pre></figure>

<p>Again there is a lot going on here so explore the documentation to make sure you understand it. 
Try out different colour values as well.</p>

<p>Add a title and replace the axes names with “easting” and 
“northing” and save your map as a pdf.</p>

<h1 id="taking-spatial-data-analysis-in-r-further">Taking spatial data analysis in R further</h1>

<p>The skills you have learned in this tutorial are applicable to a very wide 
range of datasets, spatial or not. Often experimentation is the 
most rewarding learning method, rather than just searching for the 
‘best’ way of doing something (Kabakoff, 2011). We recommend you play around
with your own data.</p>

<p>The supportive online communities surrounding large open source programs such as R
are one of their greatest assets, so we recommend you become an active 
“<a href="http://blog.cleverelephant.ca/2013/10/being-open-source-citizen.html">open source citizen</a>” rather than a passive consumer (Ramsey &amp; Dubovsky, 2013).</p>

<p>This does not necessarily mean writing R source code - it can simply mean helping
others use R. We therefore conclude the tutorial with a list of resources
that will help you further sharpen you R skills, find help and contribute 
to the growing online R community:</p>

<ul>
  <li>R’s homepage hosts a wealth of <a href="http://cran.r-project.org/manuals.html">official</a> and <a href="http://cran.r-project.org/other-docs.html">contributed</a> guides.</li>
  <li>Stack Exchange and GIS Stack Exchange groups - try searching for “[R]”. If your issue has not been not been addressed yet, you could post a polite question.</li>
  <li>R’s <a href="http://www.r-project.org/mail.html">mailing lists</a> - the R-sig-geo list may be of particular interest here.</li>
</ul>

<p>Books: despite the strength of R’s online community, nothing beats a physical book for concentrated learning. We would particularly recommend the following:</p>

<ul>
  <li>ggplot2: elegant graphics for data analysis (Wickham 2009)</li>
  <li>Bivand et al. (2013) Provide a dense and detailed overview of spatial 
 data analysis in an updated version of the book by the developers of many
 of R’s spatial functions.</li>
  <li>Kabacoff (2011) is a more general R book; it has many fun worked examples.</li>
</ul>

<h1 id="references">References</h1>

<p>Bivand, R. S., Pebesma, E. J., &amp; Rubio, V. G. (2008). Applied spatial data: analysis with R. Springer.</p>

<p>Harris, R. (2012). A Short Introduction to R. 
<a href="http://www.social-statistics.org/">social-statistics.org</a>.</p>

<p>Kabacoff, R. (2011). R in Action. Manning Publications Co.</p>

<p>Ramsey, P., &amp; Dubovsky, D. (2013). Geospatial Software’s Open Future. 
GeoInformatics, 16(4).</p>

<p>Torfs and Brauer (2012). A (very) short Introduction to R. The Comprehensive R Archive Network.</p>

<p>Wickham, H. (2009). ggplot2: elegant graphics for data analysis. Springer.</p>

<p>Wilkinson, L. (2005). The grammar of graphics. Springer.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">source</span><span class="p">(</span><span class="s2">"latex/rmd2pdf.R"</span><span class="p">)</span><span class="w"> </span><span class="c1"># convert .Rmd to .tex file</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Warning in file(filename, "r", encoding = encoding): cannot open file
## 'latex/rmd2pdf.R': No such file or directory</code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## Error in file(filename, "r", encoding = encoding): cannot open the connection</code></pre></figure>


	    
    </div>
  </div>
</div>



    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links"><li><a href="/Creating-maps-in-R/feed.xml" title=""><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only"></span>
              </a>
            </li><li><a href="the.statistics.network@gmail.com" title=""><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only"></span>
              </a>
            </li><li><a href="StatisticsNetwork" title=""><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only"></span>
              </a>
            </li><li><a href="davan690" title=""><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only"></span>
              </a>
            </li><li><a href="antsStats" title=""><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only"></span>
              </a>
            </li><li><a href="statistical_adventures" title=""><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only"></span>
              </a>
            </li><li><a href="+61401258042" title=""><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only"></span>
              </a>
            </li></ul>
      <p class="copyright text-muted">
      Anthony Davidson
      &nbsp;&bull;&nbsp;
      2019

      
      &nbsp;&bull;&nbsp;
      <a href="http://localhost:4000">ssnhub.com</a>
      

      
      </p>
          <!-- Please don't remove this, keep my open source work credited :) -->
    <p class="theme-by text-muted">
      Theme by
      <a href="https://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
    </p>
      </div>
    </div>
  </div>
</footer>

  
    






  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script>
      	if (typeof jQuery == 'undefined') {
      	  document.write('<script src="/Creating-maps-in-R/js/jquery-1.11.2.min.js"></scr' + 'ipt>');
      	}
      </script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
	<script src="/Creating-maps-in-R/js/bootstrap.min.js"></script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
	<script src="/Creating-maps-in-R/js/main.js"></script>
    
  


<a href="https://paypal.me/ARDavidson?locale.x=en_AU"><img src="https://img.shields.io/badge/Donate-PayPal-green.svg" alt="Donate" /></a>
    <script>
    $( document ).ready(function() {
        $('a').each( function() {
            if ($(this).text().match("^\\[") && $(this).text().match("\\]$")) {
                $(this).addClass('btn').addClass('btn-primary');
                $(this).text($(this).text().substring(1, $(this).text().length-1));
            }
        });
    });
</script>

  </body>
<script>
  (function() {
    var cx = '010061006416176013100:a0xb_zzxe0q';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
</html>
