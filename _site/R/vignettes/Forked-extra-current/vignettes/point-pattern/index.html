<!DOCTYPE html>
<html lang="en">
  <!-- Beautiful Jekyll | MIT license | Copyright Dean Attali 2016 -->
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">

  <title>Point Pattern analysis and spatial interpolation with R</title>

  <link rel="shortcut icon" type="image/x-icon" href="/img/Centre-logo.jpg">

  <meta name="author" content="Anthony Davidson" />

  

  <link rel="alternate" type="application/rss+xml" title="Creating maps in R - GIS and statistical support for researchers" href="/Creating-maps-in-R/feed.xml" />

  

  

  


  
    
      
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css" />


    
  

  
    
      <link rel="stylesheet" href="/Creating-maps-in-R/css/bootstrap.min.css" />
    
      <link rel="stylesheet" href="/Creating-maps-in-R/css/bootstrap-social.css" />
    
      <link rel="stylesheet" href="/Creating-maps-in-R/css/main.css" />
    
  

  
    
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
    
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
    
  

  

  

  

    <!-- Facebook OpenGraph tags -->
  

  
  <meta property="og:title" content="Point Pattern analysis and spatial interpolation with R" />
  

   
  <meta property="og:description" content="Point Pattern analysis and spatial interpolation with R ================ - [Introduction](#introduction) - [Data](#data) - [Point density](#point-density) - [Exercises](#exercises) - [Challenges](#challenges) - [Points in polygons and raster cells](#points-in-polygons-and-raster-cells) - [Exercises](#exercises-1) - [Challenge](#challenge) - [Exercises](#exercises-2) - [Point distance analysis](#point-distance-analysis) - [Spatial interpolation](#spatial-interpolation) - [Exercises](#exercises-3) - [Voronoi polygon interpoloation](#voronoi-polygon-interpoloation) - [Exercises](#exercises-4) - [Interpolation...">
  


  <meta property="og:type" content="website" />

  
  <meta property="og:url" content="http://localhost:4000/R/vignettes/Forked-extra-current/vignettes/point-pattern/" />
  <link rel="canonical" href="http://localhost:4000/R/vignettes/Forked-extra-current/vignettes/point-pattern/" />
  

  
  <meta property="og:image" content="http://localhost:4000/img/centre-logo-white.jpg" />
  


  <!-- Twitter summary cards -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <meta name="twitter:creator" content="@" />

  
  <meta name="twitter:title" content="Point Pattern analysis and spatial interpolation with R" />
  

  
  <meta name="twitter:description" content="Point Pattern analysis and spatial interpolation with R ================ - [Introduction](#introduction) - [Data](#data) - [Point density](#point-density) - [Exercises](#exercises) - [Challenges](#challenges) - [Points in polygons and raster cells](#points-in-polygons-and-raster-cells) - [Exercises](#exercises-1) - [Challenge](#challenge) - [Exercises](#exercises-2) - [Point distance analysis](#point-distance-analysis) - [Spatial interpolation](#spatial-interpolation) - [Exercises](#exercises-3) - [Voronoi polygon interpoloation](#voronoi-polygon-interpoloation) - [Exercises](#exercises-4) - [Interpolation...">
  

  
  <meta name="twitter:image" content="http://localhost:4000/img/centre-logo-white.jpg" />
  

  

  

</head>

  
  <body>

    

  
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
        <a class="navbar-brand" href="http://localhost:4000">Creating maps in R</a>
      
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
          <li>
            






<a href="/Creating-maps-in-R/Creating-maps-in-R">Home</a>

          </li>
        
        
        
          <li class="navlinks-container">
            <a class="navlinks-parent" href="javascript:void(0)">Info</a>
            <div class="navlinks-children">
              
                
                  






<a href="https://www.ssnhub.com/cv-ard">CV(draft only)</a>

                
              
            </div>
          </li>
        
        
      </ul>
    </div>

	
	<div class="avatar-container">
	  <div class="avatar-img-border">
	    <a href="http://localhost:4000">
	      <img class="avatar-img" src="/Creating-maps-in-R/img/centre-logo-white.jpg" />
		</a>
	  </div>
	</div>
	

  </div>
</nav>


    <!-- TODO this file has become a mess, refactor it -->





<header class="header-section ">

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-heading">
          <h1>Point Pattern analysis and spatial interpolation with R</h1>
		  
		  
		  
        </div>
      </div>
    </div>
  </div>
</div>
</header>





<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <h1 id="point-pattern-analysis-and-spatial-interpolation-with-r">Point Pattern analysis and spatial interpolation with R</h1>

<ul>
  <li><a href="#introduction">Introduction</a>
    <ul>
      <li><a href="#data">Data</a></li>
    </ul>
  </li>
  <li><a href="#point-density">Point density</a>
    <ul>
      <li><a href="#exercises">Exercises</a></li>
      <li><a href="#challenges">Challenges</a></li>
    </ul>
  </li>
  <li><a href="#points-in-polygons-and-raster-cells">Points in polygons and raster cells</a>
    <ul>
      <li><a href="#exercises-1">Exercises</a></li>
      <li><a href="#challenge">Challenge</a></li>
      <li><a href="#exercises-2">Exercises</a></li>
    </ul>
  </li>
  <li><a href="#point-distance-analysis">Point distance analysis</a></li>
  <li><a href="#spatial-interpolation">Spatial interpolation</a>
    <ul>
      <li><a href="#exercises-3">Exercises</a></li>
    </ul>
  </li>
  <li><a href="#voronoi-polygon-interpoloation">Voronoi polygon interpoloation</a>
    <ul>
      <li><a href="#exercises-4">Exercises</a></li>
    </ul>
  </li>
  <li><a href="#interpolation-with-the-gstat-package">Interpolation with the gstat package</a>
    <ul>
      <li><a href="#exercises-5">Exercises</a></li>
    </ul>
  </li>
  <li><a href="#references">References</a></li>
</ul>

<h1 id="introduction">Introduction</h1>

<p>This tutorial teaches the basics of point pattern analysis in R. It is influenced by the chapter on Spatial Point Pattern Analysis in <em>Applied Spatial Data Analysis with R</em> (Bivand, Pebesma, and Gómez-Rubio 2013) and an <a href="http://rspatial.org/analysis/rst/8-pointpat.html">online tutorial</a> on Point Pattern Analyis by Robert Hijmans.</p>

<p>We will use the <strong>sp</strong> package for this rather than the newer <strong>sf</strong> package, as point pattern analysis is more established for the formers <code class="highlighter-rouge">Spatial</code> class system than the latter’s <code class="highlighter-rouge">sf</code> classes. We will also use <strong>raster</strong> as it has concise and well-designed functions for spatial data:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tmap</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">mapview</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Loading required package: leaflet
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">dismo</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">gstat</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h2 id="data">Data</h2>

<p>This tutorial assumes you have downloaded the GitHub repo <a href="https://github.com/Robinlovelace/Creating-maps-in-R"><code class="highlighter-rouge">robinlovelace/Creating-maps-in-R</code></a> and that the working directory of your R session is the root directory of this project.</p>

<!-- Could say how to this with download.file... -->
<p>The input datasets, cunningly stored in the <code class="highlighter-rouge">data/</code> directory, are on ‘Boris Bikes’ docking stations around London, and can be read-in and visualised with the following commands:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rgdal</span><span class="o">::</span><span class="n">readOGR</span><span class="p">(</span><span class="s2">"data/lnd.geojson"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## OGR data source with driver: GeoJSON 
## Source: "data/lnd.geojson", layer: "OGRGeoJSON"
## with 33 features
## It has 7 fields
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cycle_hire</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rgdal</span><span class="o">::</span><span class="n">readOGR</span><span class="p">(</span><span class="s2">"data/cycle_hire.geojson"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## OGR data source with driver: GeoJSON 
## Source: "data/cycle_hire.geojson", layer: "OGRGeoJSON"
## with 742 features
## It has 5 fields
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cycle_hire_osm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rgdal</span><span class="o">::</span><span class="n">readOGR</span><span class="p">(</span><span class="s2">"data/cycle_hire-osm.geojson"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## OGR data source with driver: GeoJSON 
## Source: "data/cycle_hire-osm.geojson", layer: "OGRGeoJSON"
## with 532 features
## It has 5 fields
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="n">cycle_hire</span><span class="p">)</span><span class="w">
</span><span class="n">points</span><span class="p">(</span><span class="n">cycle_hire_osm</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"red"</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">lnd</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/Creating-maps-in-R/R/vignettes/Forked-extra-current/vignettes/point-pattern_files/figure-markdown_github/cycle-hire1-1.png" alt="" /></p>

<p>It is immediately clear that the two datasets on cycle hire points are closely related (they have a high degree of spatial correlation) and have a distinctive pattern. <code class="highlighter-rouge">cycle_hire</code> represents official data on cycle parking, and will be the main point dataset analysed. <code class="highlighter-rouge">cycle_hire_osm</code> is the community contributed dataset on cycle hire locations, downloaded from OpenStreetMap. Both sets of points overlay some of London’s 33 boroughs, the central ones, and seem to follow the River Thames, especially along the north bank of the river. But how to describe that information quantitively, and extrapolate the values from the plotted location to other areas?</p>

<p>It is the purpose of this tutorial to provide the know-how to answer such questions, that should be extensible to many applications that involve point data.</p>

<h1 id="point-density">Point density</h1>

<p>A basic statistic to compute on points within a polygon is the number of points per polygon, and the related statistic of point density. Let’s first compute that for London overall, before doing a zone-by-zone breakdown:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nrow</span><span class="p">(</span><span class="n">cycle_hire</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [1] 742
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lnd_area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">area</span><span class="p">(</span><span class="n">lnd</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">1e6</span><span class="w">
</span></code></pre></div></div>

<p>The results show that there are 742 cycle hire points and that London covers an area of just over one and a half thousand square kilometres (1 km<sup>2</sup> = 1000000 m<sup>2</sup> = 1e6 m<sup>2</sup> in scientific notation). That represents on average roughly one cycle parking rental space per 2 square kilometers, or half a rental point per square kilometer, as revealed by the results of the calculation below:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nrow</span><span class="p">(</span><span class="n">cycle_hire</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w">
  </span><span class="n">lnd_area</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [1] 0.4714415
</code></pre></div></div>

<p>This is not a good indicator of the density of the bike hire scheme overall, because they are so concentrated in central London. A more representative result can be found by calculating the average point density <em>within the extent of the bike hire scheme</em>. We can coerce the bounding box (or extent in <strong>raster</strong> terminology) of the stations into a polygon whose area can be measured with the following commands:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bb_hire</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as</span><span class="p">(</span><span class="n">extent</span><span class="p">(</span><span class="n">cycle_hire</span><span class="p">),</span><span class="w"> </span><span class="s2">"SpatialPolygons"</span><span class="p">)</span><span class="w">
</span><span class="n">crs</span><span class="p">(</span><span class="n">bb_hire</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crs</span><span class="p">(</span><span class="n">lnd</span><span class="p">)</span><span class="w">
</span><span class="n">c_area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">area</span><span class="p">(</span><span class="n">bb_hire</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">1e6</span><span class="w">
</span></code></pre></div></div>

<h2 id="exercises">Exercises</h2>

<ul>
  <li>What is the average point density of cycle hire points within the scheme’s bounding box?</li>
</ul>

<!-- ```{r} -->
<!-- c_area = area(bb_hire) / 1e6 -->
<!-- nrow(cycle_hire) / c_area -->
<!-- ``` -->
<ul>
  <li>Why did we add the second line of code in the previous code chunk?</li>
  <li>Why are there two <code class="highlighter-rouge">crs()</code> calls?</li>
  <li>The above chunk uses <strong>raster</strong> functions. How would you write the above code using <strong>sp</strong> code?</li>
</ul>

<h2 id="challenges">Challenges</h2>

<ul>
  <li>Reproduce the result using <strong>sp</strong> code.</li>
  <li>Reproduce the resuts using <strong>sf</strong> code.</li>
</ul>

<h1 id="points-in-polygons-and-raster-cells">Points in polygons and raster cells</h1>

<p>A useful level of analysis at which to analyse the geographical distribution of points is the zone-level. We can aggregate the points per zone and provide summary statistics. Starting with the number of points per polygon, this would calculated as follows:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cycle_hire_ag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aggregate</span><span class="p">(</span><span class="n">cycle_hire</span><span class="p">[</span><span class="s2">"id"</span><span class="p">],</span><span class="w"> </span><span class="n">lnd</span><span class="p">,</span><span class="w"> </span><span class="n">FUN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"length"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h2 id="exercises-1">Exercises</h2>

<p>Based on an analysis of the <code class="highlighter-rouge">cycle_hire_ag</code>:</p>

<ul>
  <li>How many zones contain no cycle hire points?</li>
  <li>What is the average number of cycle hire points per zone?</li>
</ul>

<h2 id="challenge">Challenge</h2>

<p>Find the average density of cycle hire points per zone in London.</p>

<ul>
  <li>Plot the result in an attractive map (e.g. as shown below).</li>
  <li>Find which zone has the highest density of cycle hire points.</li>
</ul>

<!-- ```{r zonedense} -->
<!-- lnd_areas = area(lnd) / 1e6 -->
<!-- lnd$`cycle_hire_density` = cycle_hire_ag$id / lnd_areas -->
<!-- library(tmap) -->
<!-- bb = tmaptools::bb(cycle_hire, 2) -->
<!-- ft = "Cycle hire density\n(per square km)" -->
<!-- # tmap_mode("view") -->
<!-- (m = qtm(lnd, "cycle_hire_density", fill.title = ft, bbox = bb)) -->
<!-- # save_tmap(tm = m, filename = "figure/cyle-hire-lnd.png", width = 600) -->
<!-- lnd$NAME[which.max(lnd$cycle_hire_density)] -->
<!-- ``` -->
<p><img src="/Creating-maps-in-R/R/vignettes/Forked-extra-current/vignettes/point-pattern_files/figure-markdown_github/zonedense-1.png" alt="" /></p>

<p>A problem with the zonal representation of point density is that the results are dependent on the somewhat arbitrary shapes and sizes of the zones in which the points are aggregated. To overcome this problem we can create a raster representation of the points:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">raster</span><span class="p">(</span><span class="n">bb_hire</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w">
</span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rasterize</span><span class="p">(</span><span class="n">cycle_hire</span><span class="o">@</span><span class="n">coords</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">fun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"count"</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span><span class="w">
</span><span class="n">points</span><span class="p">(</span><span class="n">cycle_hire</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">lnd</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/Creating-maps-in-R/R/vignettes/Forked-extra-current/vignettes/point-pattern_files/figure-markdown_github/unnamed-chunk-7-1.png" alt="" /></p>

<p>This is already very useful. The results show that there are 5 clusters of cycle parking with much higher density than the surrounding areas. We can visualise these clusters using a static plot as follows:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/Creating-maps-in-R/R/vignettes/Forked-extra-current/vignettes/point-pattern_files/figure-markdown_github/unnamed-chunk-8-1.png" alt="" /></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="n">rc</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">12</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/Creating-maps-in-R/R/vignettes/Forked-extra-current/vignettes/point-pattern_files/figure-markdown_github/unnamed-chunk-8-2.png" alt="" /></p>

<p>More useful, in terms of characterising the geographical characteristics of each cluster, would be to plot these 5 clusters interactively. Do this with <strong>mapview</strong>:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">mapview</span><span class="p">)</span><span class="w">
</span><span class="n">mapview</span><span class="p">(</span><span class="n">rc</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">12</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">mapview</span><span class="p">(</span><span class="n">cycle_hire</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/Creating-maps-in-R/R/vignettes/Forked-extra-current/vignettes/point-pattern_files/figure-markdown_github/unnamed-chunk-9-1.png" alt="" /></p>

<p>The resulting interactive plot draws attention to the areas of high point density, such as the area surrounding Victoria station, illustrated below.</p>

<p><img src="/Creating-maps-in-R/R/vignettes/Forked-extra-current/vignettes/point-pattern_files/figure-markdown_github/victoria-plot.png" alt="" /></p>

<h2 id="exercises-2">Exercises</h2>

<ul>
  <li>Explore the interactive map created by <strong>mapview</strong> above.</li>
  <li>Try to explain the location of the high density clusters: what are they near?</li>
  <li>Where would you suggest building more cycle hire points?</li>
</ul>

<h1 id="point-distance-analysis">Point distance analysis</h1>

<p>Another important characteristic of point patterns is the distances between points, which can be calculated using <strong>raster</strong>’s <code class="highlighter-rouge">dist()</code> function:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spDists</span><span class="p">(</span><span class="n">cycle_hire</span><span class="p">,</span><span class="w"> </span><span class="n">longlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">dm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.matrix</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="w">
</span><span class="n">dm</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>##          [,1]     [,2]     [,3]      [,4]     [,5]
## [1,] 0.000000 6.913473 1.966592 0.7700464 5.164896
## [2,] 6.913473 0.000000 8.205219 6.3051094 2.916743
## [3,] 1.966592 8.205219 0.000000 2.7062514 5.915129
</code></pre></div></div>

<p>The results show the distance, in km, form every point to every other. The <code class="highlighter-rouge">dm</code> object is known as a distance matrix: not the diagonal of zero values. This distance matrix is very useful for various types of analysis, a couple of which we’ll explore below.</p>

<p>To find the minimum distance of each point to every other, we can use the <code class="highlighter-rouge">apply</code> function, for each row, and then select the top 5:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">diag</span><span class="p">(</span><span class="n">dm</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NA</span><span class="w">
</span><span class="n">dmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">apply</span><span class="p">(</span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dm</span><span class="p">,</span><span class="w"> </span><span class="n">MARGIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">FUN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">sel_isolated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">order</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span><span class="w"> </span><span class="n">decreasing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)[</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">]</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">cycle_hire</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey"</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Isolated points"</span><span class="p">)</span><span class="w">
</span><span class="n">points</span><span class="p">(</span><span class="n">cycle_hire</span><span class="p">[</span><span class="n">sel_isolated</span><span class="p">,])</span><span class="w">
</span></code></pre></div></div>

<p><img src="/Creating-maps-in-R/R/vignettes/Forked-extra-current/vignettes/point-pattern_files/figure-markdown_github/unnamed-chunk-11-1.png" alt="" /></p>

<p>Another plot that is useful is that of the ‘G function’ for exploring the extent to which points cluster or separate compared with what would be expected from a random distribution (Bivand, Pebesma, and Gómez-Rubio 2013):</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">distance</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sort</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="nf">round</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span><span class="w"> </span><span class="n">digits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">)))</span><span class="w">
</span><span class="n">Gd</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sapply</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">dmin</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">x</span><span class="p">))</span><span class="w">
</span><span class="n">Gd</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Gd</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">dmin</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span><span class="w"> </span><span class="n">Gd</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/Creating-maps-in-R/R/vignettes/Forked-extra-current/vignettes/point-pattern_files/figure-markdown_github/unnamed-chunk-12-1.png" alt="" /></p>

<h1 id="spatial-interpolation">Spatial interpolation</h1>

<p>Spatial interpolation refers to methods of estimating the value of something in one place, based on measurements taken elsewhere. It depends on spatial autocorrelation, defined in Waldo Tobler’s ‘first law of Geography’ as follows (Miller 2004):</p>

<blockquote>
  <p>Everything is related to everything else, but near things are more related than distant thing</p>
</blockquote>

<p>Building on the example of cycle hire points in london, we can ask the question: what is the expected number of bikes for a stand in location x, given knowledge of the existing data.</p>

<p>Thus spatial interpolation requires a dependent variable, which is summarised numerically and visually below:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">summary</span><span class="p">(</span><span class="n">cycle_hire</span><span class="o">$</span><span class="n">nbikes</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##     0.0     3.0    11.0    12.2    19.0    51.0
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tm_shape</span><span class="p">(</span><span class="n">cycle_hire</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">tm_symbols</span><span class="p">(</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"nbikes"</span><span class="p">,</span><span class="w"> </span><span class="n">palette</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"YlOrRd"</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.6</span><span class="p">,</span><span class="w"> </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"quantile"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/Creating-maps-in-R/R/vignettes/Forked-extra-current/vignettes/point-pattern_files/figure-markdown_github/unnamed-chunk-13-1.png" alt="" /></p>

<p>There is a clear spatial pattern to this: there are more bikes parked in the outer docking stations. We can say that verbally, but how to we represent that on the map?</p>

<p>A first port of call would be to rasterise the result, using the the raster representation of the study area contained in the object <code class="highlighter-rouge">r</code> to find the mean per cell:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rnbikes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rasterize</span><span class="p">(</span><span class="n">cycle_hire</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"nbikes"</span><span class="p">,</span><span class="w"> </span><span class="n">fun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">rnbikes</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/Creating-maps-in-R/R/vignettes/Forked-extra-current/vignettes/point-pattern_files/figure-markdown_github/unnamed-chunk-14-1.png" alt="" /></p>

<p>What about estimating the values of cells outside the current network area? We can use <strong>raster</strong>’s <code class="highlighter-rouge">focal()</code> function to estimate that.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">9</span><span class="p">,</span><span class="w"> </span><span class="n">nr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">9</span><span class="p">)</span><span class="w">
</span><span class="n">r_interp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">focal</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rnbikes</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">fun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">,</span><span class="w"> </span><span class="n">NAonly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">pad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">r_interp1</span><span class="p">)</span><span class="w">
</span><span class="n">points</span><span class="p">(</span><span class="n">cycle_hire</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/Creating-maps-in-R/R/vignettes/Forked-extra-current/vignettes/point-pattern_files/figure-markdown_github/unnamed-chunk-15-1.png" alt="" /></p>

<h2 id="exercises-3">Exercises</h2>

<ul>
  <li>Experiment with different matrix sizes of <code class="highlighter-rouge">w</code> in the above code block. What difference does the size make?</li>
  <li>Note that the 9x9 cell focal point leads to an ‘over smoothing’ of the results. Find a way to include only values from touching cells in the results.</li>
</ul>

<h1 id="voronoi-polygon-interpoloation">Voronoi polygon interpoloation</h1>

<p>The raster cell method of spatial interpolation was fun, but not that sophisticated or spatially precise, with a resolution of around 1 km.</p>

<p>The next simplest solution is to break the area up into pieces and assign the value of the entire area to the value of the point it contains:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">dismo</span><span class="p">)</span><span class="w">
</span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">voronoi</span><span class="p">(</span><span class="n">cycle_hire</span><span class="p">)</span><span class="w">
</span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intersect</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Warning in intersect(x, y): non identical CRS
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tm_shape</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">tm_fill</span><span class="p">(</span><span class="s2">"nbikes"</span><span class="p">,</span><span class="w"> </span><span class="n">palette</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"YlOrRd"</span><span class="p">,</span><span class="w"> </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"quantile"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">qtm</span><span class="p">(</span><span class="n">cycle_hire</span><span class="p">,</span><span class="w"> </span><span class="n">symbols.size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/Creating-maps-in-R/R/vignettes/Forked-extra-current/vignettes/point-pattern_files/figure-markdown_github/unnamed-chunk-16-1.png" alt="" /></p>

<h2 id="exercises-4">Exercises</h2>

<ul>
  <li>Create a point at a random location on the map and plot it prominently on top of the previously plotted layers.</li>
  <li>What would be it’s estimated ‘nbikes’ a) from the voronoi polygon interpolation and b) from the raster interpolation.</li>
  <li>Which do you think is most accurate?</li>
</ul>

<h1 id="interpolation-with-the-gstat-package">Interpolation with the gstat package</h1>

<p><strong>gstat</strong> provides a number of functions for spatial prediction and interpolation using a range of models. The most basic of these, and a workhorse for spatial interpolation is Inverse Distance Weighting (IDW):</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">gstat</span><span class="p">)</span><span class="w">
</span><span class="n">gs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gstat</span><span class="p">(</span><span class="n">formula</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nbikes</span><span class="o">~</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">locations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cycle_hire</span><span class="p">)</span><span class="w">
</span><span class="n">r_idw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">interpolate</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">gs</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [inverse distance weighted interpolation]
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="n">r_idw</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/Creating-maps-in-R/R/vignettes/Forked-extra-current/vignettes/point-pattern_files/figure-markdown_github/unnamed-chunk-17-1.png" alt="" /></p>

<h2 id="exercises-5">Exercises</h2>

<ul>
  <li>Look at the original data - what could explain the spatial distribution of the <code class="highlighter-rouge">nbikes</code> variable?</li>
  <li>Experiment with the spatial resolution - we’re using 1 km grid cells which are huge!</li>
  <li>Try using other methods described in Rober Hijman’s <a href="http://rspatial.org/analysis/rst/4-interpolation.html">tutorial</a> on spatial interpolation.</li>
  <li>Try cross-validating the results. Which performs best?</li>
</ul>

<h1 id="references">References</h1>

<p>Bivand, Roger S, Edzer J Pebesma, and Virgilio Gómez-Rubio. 2013. <em>Applied Spatial Data Analysis with R</em>. Vol. 747248717. Springer.</p>

<p>Miller, Harvey J. 2004. <em>Tobler’s First Law and Spatial Analysis</em>. Vol. 94. March 2015.</p>

	    
    </div>
  </div>
</div>



    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links"><li><a href="/Creating-maps-in-R/feed.xml" title=""><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only"></span>
              </a>
            </li><li><a href="the.statistics.network@gmail.com" title=""><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only"></span>
              </a>
            </li><li><a href="StatisticsNetwork" title=""><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only"></span>
              </a>
            </li><li><a href="davan690" title=""><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only"></span>
              </a>
            </li><li><a href="antsStats" title=""><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only"></span>
              </a>
            </li><li><a href="statistical_adventures" title=""><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only"></span>
              </a>
            </li><li><a href="+61401258042" title=""><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only"></span>
              </a>
            </li></ul>
      <p class="copyright text-muted">
      Anthony Davidson
      &nbsp;&bull;&nbsp;
      2019

      
      &nbsp;&bull;&nbsp;
      <a href="http://localhost:4000">ssnhub.com</a>
      

      
      </p>
          <!-- Please don't remove this, keep my open source work credited :) -->
    <p class="theme-by text-muted">
      Theme by
      <a href="https://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
    </p>
      </div>
    </div>
  </div>
</footer>

  
    






  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script>
      	if (typeof jQuery == 'undefined') {
      	  document.write('<script src="/Creating-maps-in-R/js/jquery-1.11.2.min.js"></scr' + 'ipt>');
      	}
      </script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
	<script src="/Creating-maps-in-R/js/bootstrap.min.js"></script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
	<script src="/Creating-maps-in-R/js/main.js"></script>
    
  


<a href="https://paypal.me/ARDavidson?locale.x=en_AU"><img src="https://img.shields.io/badge/Donate-PayPal-green.svg" alt="Donate" /></a>
    <script>
    $( document ).ready(function() {
        $('a').each( function() {
            if ($(this).text().match("^\\[") && $(this).text().match("\\]$")) {
                $(this).addClass('btn').addClass('btn-primary');
                $(this).text($(this).text().substring(1, $(this).text().length-1));
            }
        });
    });
</script>

  </body>
<script>
  (function() {
    var cx = '010061006416176013100:a0xb_zzxe0q';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
</html>
